name: Build Proton WCP

on:
  workflow_dispatch:
    inputs:
      proton_version:
        description: 'Proton version to build (e.g., 10.0)'
        required: true
        default: '10.0'
      app_id:
        description: 'Steam App ID for Proton (e.g., 2348590 for Proton 10.0)'
        required: true
        default: '2348590'
  push:
    tags:
      - '*'

jobs:
  build-wcp:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      actions: read    # Required for workflow metadata
    env:
      APP_ID: ${{ inputs.app_id || '2348590' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Proton metadata
        run: |
          if [ -n "${{ inputs.proton_version }}" ]; then
            version="${{ inputs.proton_version }}"
          else
            version="${GITHUB_REF_NAME#proton-}"
          fi
          if [ "${{ github.ref_type }}" = "tag" ]; then
            tag_name="${GITHUB_REF_NAME}"
          else
            tag_name="proton-$version"
          fi
          if [[ "$version" =~ ^[0-9]+\.[0-9]+$ ]]; then
            wcp_version="${version}-1"
          else
            wcp_version="$version"
          fi
          display_version="${version%%-*}"
          echo "PROTON_VERSION=$version" >> "$GITHUB_ENV"
          echo "PROTON_DISPLAY_VERSION=$display_version" >> "$GITHUB_ENV"
          echo "WCP_VERSION=$wcp_version" >> "$GITHUB_ENV"
          echo "TAG_NAME=$tag_name" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget lib32gcc-s1 xz-utils

      - name: Download and install SteamCMD
        run: |
          mkdir -p ~/steamcmd
          cd ~/steamcmd
          wget https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz
          tar -xvzf steamcmd_linux.tar.gz
          chmod +x steamcmd.sh

      - name: Download Proton with SteamCMD
        env:
          STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
          STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
        run: |
          mkdir -p ~/proton_download
          cd ~/steamcmd
          
          # Create SteamCMD script with proper variable expansion
          cat > download_proton.txt << EOF
          @ShutdownOnFailedCommand 1
          @NoPromptForPassword 1
          force_install_dir $HOME/proton_download
          login $STEAM_USERNAME $STEAM_PASSWORD
          app_update ${{ env.APP_ID }} validate
          quit
          EOF
          
          # Run SteamCMD with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Download attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            if ./steamcmd.sh +runscript download_proton.txt; then
              echo "Download successful!"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Download failed, retrying in 10 seconds..."
                sleep 10
              else
                echo "Download failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done

      - name: Transform Proton to Wine structure
        run: |
          mkdir -p ~/wcp_output/{bin,lib,share}
          
          # Copy executables to bin/
          if [ -d ~/proton_download/files/bin ]; then
            cp -r ~/proton_download/files/bin/* ~/wcp_output/bin/ || true
          fi
          
          # Copy libraries to lib/
          if [ -d ~/proton_download/files/lib ]; then
            cp -r ~/proton_download/files/lib/* ~/wcp_output/lib/ || true
          fi
          if [ -d ~/proton_download/files/lib64 ]; then
            cp -r ~/proton_download/files/lib64/* ~/wcp_output/lib/ || true
          fi
          
          # Copy shared resources to share/
          if [ -d ~/proton_download/files/share ]; then
            cp -r ~/proton_download/files/share/* ~/wcp_output/share/ || true
          fi
          
          # List the structure for verification
          echo "=== Output structure ==="
          ls -la ~/wcp_output/
          echo "=== bin/ ==="
          ls -la ~/wcp_output/bin/ | head -20
          echo "=== lib/ ==="
          ls -la ~/wcp_output/lib/ | head -20
          echo "=== share/ ==="
          ls -la ~/wcp_output/share/ | head -20

      - name: Generate wcp.json manifest
        run: |
          cat > ~/wcp_output/wcp.json << EOF
          {
            "name": "Proton ${{ env.PROTON_DISPLAY_VERSION }}",
            "version": "${{ env.WCP_VERSION }}",
            "description": "Valve's Proton compatibility layer converted for Winlator",
            "wine_version": "proton-${{ env.PROTON_DISPLAY_VERSION }}"
          }
          EOF
          
          echo "=== Generated wcp.json ==="
          cat ~/wcp_output/wcp.json

      - name: Create prefix pack
        run: |
          prefix_source=~/proton_download/files/share/default_pfx
          prefix_pack=~/wcp_output/prefixPack.txz
          if [ -d "$prefix_source" ]; then
            tar -cJf "$prefix_pack" -C "$prefix_source" .
          else
            tar -cJf "$prefix_pack" --files-from /dev/null
          fi
          echo "=== prefixPack.txz ==="
          ls -lh "$prefix_pack"

      - name: Generate profile.json manifest
        run: |
          cat > ~/wcp_output/profile.json << EOF
          {
            "type": "Proton",
            "versionName": "${{ env.PROTON_VERSION }}",
            "versionCode": 0,
            "description": "Valve's Proton compatibility layer converted for Winlator",
            "files": [],
            "proton": {
              "binPath": "bin",
              "libPath": "lib",
              "prefixPack": "prefixPack.txz"
            }
          }
          EOF
          
          echo "=== Generated profile.json ==="
          cat ~/wcp_output/profile.json

      - name: Create WCP archive
        run: |
          # Verify structure before archiving
          echo "=== Files to be included in WCP ==="
          ls -la ~/wcp_output
          
          # Create tar.xz archive (wcp.json must be at root)
          tar -cJf proton-${{ env.PROTON_VERSION }}.wcp -C ~/wcp_output .
          
          # Move to workspace for artifact upload
          if [ "$PWD" != "${{ github.workspace }}" ]; then
            mv proton-${{ env.PROTON_VERSION }}.wcp ${{ github.workspace }}/
          fi
          
          echo "=== WCP archive created ==="
          ls -lh ${{ github.workspace }}/proton-${{ env.PROTON_VERSION }}.wcp

      - name: Upload WCP as artifact
        uses: actions/upload-artifact@v4
        with:
          name: proton-${{ env.PROTON_VERSION }}-wcp
          path: proton-${{ env.PROTON_VERSION }}.wcp
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Proton ${{ env.PROTON_VERSION }} WCP
          body: |
            # Proton ${{ env.PROTON_VERSION }} WCP Package
            
            Automated build of Proton ${{ env.PROTON_VERSION }} converted to Winlator Custom Package format.
            
            ## Installation
            1. Download the `.wcp` file
            2. Import it into Winlator on your Android device
            
            ## Build Information
            - **Proton Version**: ${{ env.PROTON_VERSION }}
            - **Steam App ID**: ${{ env.APP_ID }}
            - **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: proton-${{ env.PROTON_VERSION }}.wcp
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
