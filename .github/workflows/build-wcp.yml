name: Build Proton WCP

on:
  workflow_dispatch:
    inputs:
      proton_version:
        description: Proton version label (leave blank for latest)
        required: false
        default: "latest"
      wcp_version:
        description: wcp.json version string
        required: false
        default: ""
      proton_branch:
        description: Optional Steam beta branch
        required: false
  push:
    tags:
      - "proton-*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      STEAM_USERNAME: ${{ secrets.STEAM_USERNAME }}
      STEAM_PASSWORD: ${{ secrets.STEAM_PASSWORD }}
      STEAM_GUARD_CODE: ${{ secrets.STEAM_GUARD_CODE }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y steamcmd zip
          apt-cache policy steamcmd
          steamcmd_version=$(dpkg-query -W -f='${Version}' steamcmd)
          echo "steamcmd version: ${steamcmd_version}" >> "$GITHUB_STEP_SUMMARY"

      - name: Resolve versions
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            proton_version="${{ inputs.proton_version }}"
            wcp_version="${{ inputs.wcp_version }}"
            proton_branch="${{ inputs.proton_branch }}"
            if [[ -z "$proton_version" ]]; then
              proton_version="latest"
            fi
            tag_name=""
          else
            tag="${GITHUB_REF_NAME}"
            proton_version="${tag#proton-}"
            wcp_version="$proton_version"
            proton_branch=""
            tag_name="$tag"
          fi

          echo "proton_version=$proton_version" >> "$GITHUB_OUTPUT"
          echo "wcp_version=$wcp_version" >> "$GITHUB_OUTPUT"
          echo "proton_branch=$proton_branch" >> "$GITHUB_OUTPUT"
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Build WCP package
        env:
          PROTON_VERSION: ${{ steps.vars.outputs.proton_version }}
          WCP_VERSION: ${{ steps.vars.outputs.wcp_version }}
          PROTON_BRANCH: ${{ steps.vars.outputs.proton_branch }}
          METADATA_PATH: ${{ github.workspace }}/work/metadata.json
        run: |
          chmod +x scripts/build_wcp.sh
          ./scripts/build_wcp.sh

      - name: Capture build metadata
        id: meta
        run: |
          set -euo pipefail
          resolved_version="${{ steps.vars.outputs.proton_version }}"
          metadata_path="${{ github.workspace }}/work/metadata.json"
          if [[ -f "$metadata_path" ]]; then
            if resolved_output="$(python3 ./scripts/parse_metadata.py "$metadata_path")"; then
              resolved_version="$resolved_output"
            else
              echo "::error::Failed to parse metadata from ${metadata_path}."
              exit 1
            fi
          else
            input_version="${{ steps.vars.outputs.proton_version }}"
            if [[ -z "$input_version" || "$input_version" == "latest" ]]; then
              echo "::error::Metadata file missing and no explicit Proton version provided."
              exit 1
            fi
            resolved_version="$input_version"
            echo "::warning::Metadata file not found at ${metadata_path}; using workflow input version."
          fi
          if [[ -z "$resolved_version" ]]; then
            echo "::error::Failed to resolve Proton version from metadata." >&2
            exit 1
          fi
          tag_name="${{ steps.vars.outputs.tag_name }}"
          if [[ -z "$tag_name" ]]; then
            tag_name="proton-$resolved_version"
          fi
          echo "proton_version=$resolved_version" >> "$GITHUB_OUTPUT"
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Publish release asset
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: Proton ${{ steps.meta.outputs.proton_version }}
          files: dist/*.wcp
          target_commitish: ${{ github.sha }}
